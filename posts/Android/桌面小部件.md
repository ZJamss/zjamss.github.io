### 新建UI布局

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:orientation="vertical">

    <ImageView
        android:id="@+id/widget_image"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:src="@drawable/preview"/>

</LinearLayout>
```


* 支持布局：`FrameLayout`，`LinearLayout`，`RelativeLayout`，`GridLayout`
* 支持控件：`AnalogClock`，`Button`，`Chronometer`，`ImageButton`，`ImageView`，`ProgressBar`，`TextView`，`ViewFlipper`，`ListView`，`GridView`，`StackView`，`AdapterViewFlipper`

### 定义配置信息

在项目 `res`目录下，新建一个名字为 `xml`目录，然后在 `res/xml/`目录下创建一个配置文件，名称随意如 `my_app_widget_info.xml`

```xml
<?xml version="1.0" encoding="utf-8"?>
<appwidget-provider xmlns:android="http://schemas.android.com/apk/res/android"
    android:initialLayout="@layout/new_app_widget"
    android:minHeight="@dimen/dp_80"
    android:minWidth="@dimen/dp_400"
    android:previewImage="@drawable/ic_zuomian"

    android:updatePeriodMillis="864000"
    android:widgetCategory="home_screen|keyguard">

    <!--android:resizeMode="horizontal|vertical"-->

</appwidget-provider>
```


* `minHeight、minWidth` 定义Widget的`最小高度和最小宽度`（Widget可以通过拉伸来调整尺寸大小）
* `previewImage` 定义添加小部件时显示的`图标`

* `initialLayout` 定义了小部件使用的`布局`。

* `updatePeriodMillis`定义小部件自动更新的周期，单位为毫秒。
* `resizeMode` 指定了` widget` 的调整尺寸的规则。可取的值有: “`horizontal`”,“`vertical`”,“`none`”。”`horizontal`”意味着`widget`可以**水平拉伸**，“`vertical`”意味着`widget`可以**竖值拉伸**，“`none`”意味着`widget` **不能拉伸；默认值是”none”**。
* `widgetCategory` 指定了 widget 能显**示的地方：**能否显示在 `home Screen` 或 `lock screen `或 两者都可以。它的取值包括：”home_screen” 和 “keyguard”。Android 4.2 引入。

**注意事项：`android:previewImage`定义的图标，如果图片放到 `mipmap`中，图片虽是矩形，但是显示出来还是圆形，故如果图片是矩形需要放到 `drawable`中**

### 定义小部件类

```java
import android.appwidget.AppWidgetManager;
import android.appwidget.AppWidgetProvider;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.util.Log;


public class MyAppWidget extends AppWidgetProvider {
    /**
     * 接收窗口小部件点击时发送的广播
     */
    @Override
    public void onReceive(Context context, Intent intent) {
        super.onReceive(context, intent);
    }
    /**
     * 每次窗口小部件被更新都调用一次该方法
     */
    @Override
    public void onUpdate(Context context, AppWidgetManager appWidgetManager, int[] appWidgetIds) {
        super.onUpdate(context, appWidgetManager, appWidgetIds);
        Log.i("AppWidget", "开始了更新");
    }
    /**
     * 每删除一次窗口小部件就调用一次
     */
    @Override
    public void onDeleted(Context context, int[] appWidgetIds) {
        super.onDeleted(context, appWidgetIds);
        //context.stopService(new Intent(context, WidgetService.class));
        Log.i("AppWidget", "删除成功！");
    }
    /**
     * 当该窗口小部件第一次添加到桌面时调用该方法
     */
    @Override
    public void onEnabled(Context context) {
        super.onEnabled(context);
       // Intent mTimerIntent = new Intent(context, WidgetService.class);
       // context.startService(mTimerIntent);
        Log.i("AppWidget", "创建成功！");
    }
    /**
     * 当最后一个该窗口小部件删除时调用该方法
     */
    @Override
    public void onDisabled(Context context) {
        super.onDisabled(context);
      //  Intent mTimerIntent = new Intent(context, WidgetService.class);
       // context.stopService(mTimerIntent);
        Log.i("AppWidget", "删除成功！");
    }
    /**
     * 当小部件大小改变时
     */
    @Override
    public void onAppWidgetOptionsChanged(Context context, AppWidgetManager appWidgetManager, int appWidgetId, Bundle newOptions) {
        super.onAppWidgetOptionsChanged(context, appWidgetManager, appWidgetId, newOptions);
    }
    /**
     * 当小部件从备份恢复时调用该方法
     */
    @Override
    public void onRestored(Context context, int[] oldWidgetIds, int[] newWidgetIds) {
        super.onRestored(context, oldWidgetIds, newWidgetIds);
    }
}
```

### 注册小部件

```xml
 <!--广播接收参数-->
        <receiver android:name=".receiver.MyAppWidget">
            <intent-filter>
                <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
            </intent-filter>
            <meta-data
                android:name="android.appwidget.provider"
                android:resource="@xml/my_app_widget_info" />
        </receiver>
```


**对如何获取并设置布局中控件样式，如颜色，字体大小，内容等**

答：`RemoteViews`没有提供 `findViewById`方法，因为 `RemoteViews`在远程进程中显示，因此无法直接访问里面的View元素，而必须通过 `RemoteViews`所提供的一系列set方法来完成，部分set方法如下所示：

![](file://C:\Users\17419\Documents\IkMarkdown\.assets\桌面小部件.md1620.879612.png)



### 提醒小部件更新

```java
 RemoteViews rv = new RemoteViews(context.getPackageName(), R.layout.my_app_widget);
//这里获得当前的包名，并且用AppWidgetManager来向NewAppWidget.class发送广播。
rv.setImageViewResource(R.id.widget_image,R.drawble.)
        AppWidgetManager manager = AppWidgetManager.getInstance(AppUMS.mContent);
        ComponentName cn = new ComponentName(context, MyAppWidget.class);
        manager.updateAppWidget(cn, rv);
```
